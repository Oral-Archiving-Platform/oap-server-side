name: Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Prevent SSH from asking to add new host key
          echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile /dev/null" >> ~/.ssh/config

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ~/.ssh/deploy_key
          script: |
            # Navigate to the project directory
            cd OAP-SERVER-SIDE
            echo "Stashing any local changes..."
            git stash --include-untracked || echo "No local changes to stash."
            
            echo "Pulling latest changes from the repository..."
            git pull origin master
            echo "Successfully pulled the latest changes."

            echo "Checking if deploy script is executable..."
            chmod +x ./scripts/deploy.sh

            echo "Running deploy script..."
            ./scripts/deploy.sh
